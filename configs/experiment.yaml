# ============================================================
# Experiment Configuration for Active Learning Color Mixing
# Set-up: laptop controls OT-2 + overhead camera
#
# Implementation Plan:
#   Phase I (controls): Left single-channel dispenses blank + pure RGB + equal-RGB mixtures (Row A wells).
#   Phase II (active learning): Right 8-channel runs experiments column-wise (placeholder until verified).
#
# Image capture is triggered from the laptop after OT-2 dispensing completes.
# ============================================================

metadata:
  name: "rgb_active_learning_v1"
  notes:
    - "Plate is in slot 1."
    - "Reservoirs: blank(diluent)=3, clean_water(rinsing only)=6, R=7, G=8, B=9."
    - "Tiprack is in slot 11."
    - "Controls are single-well in row A (A1–A8). Phase II will be finalized after verification."

# ============================================================
# Optimization target + search space
# ============================================================
target_color: [128, 0, 255]   # Target color to match (RGB 0–255)

# Volume constraint: Vr + Vg + Vb = total_volume_ul
# Search space is effectively 2D (Vb = total - Vr - Vg)
# NOTE: Max 200 µL per component (limited by 200 µL filter tips)
volume_bounds:
  min: [0, 0, 0]
  max: [200, 200, 200]
total_volume_ul: 200
step_ul: 10                    # Volume discretization step
constraint: "R_ul + G_ul + B_ul <= total_volume_ul"
derived:
  diluent_ul: "total_volume_ul - (R_ul + G_ul + B_ul)"

# Convergence threshold — stop if RGB distance < this value
convergence:
  rgb_distance_threshold: 50

seed: 42

# ============================================================
# Robot connection (HTTP API)
# ============================================================
robot:
  ip: "169.254.8.56"
  port: 31950

# ============================================================
# Pipette configuration
# ============================================================
pipettes:
  right:
    name: "p300_multi_gen2"       # 8-channel, 20-300 uL (using 200 uL filter tips)
    mount: "right"
    # NOTE: Tips at rows A, B, C, D physically removed from tiprack.
    # 8-channel only picks up 4 tips (E-H), dispensing to experiment rows only.
  left:
    name: "p300_single_gen2"      # 1-channel, 20-300 uL (using 200 uL filter tips)
    mount: "left"
    # Used for control dispensing (rows A-D)

# ============================================================
# Deck layout
#
#   Back:   [10 tips-L] [11 tips-R] [Trash]
#           [ 7 RED   ] [ 8 GREEN ] [ 9 BLUE ]
#           [ 4 WASH  ] [ 5 WATER ] [ 6 empty]
#   Front:  [ 1 PLATE ] [ 2 empty ] [ 3 empty]
# ============================================================
labware:
  tipracks:
    # 8-channel tiprack (right pipette) — rows A-D tips REMOVED
    - name: "opentrons_96_filtertiprack_200ul"
      slot: "11"
      for: "right"
      # Only rows E-H have tips. 8-channel picks up 4 tips per column.
      # Column assignment:
      #   Col 1: Red dye tips   (reused with cleaning)
      #   Col 2: Green dye tips (reused with cleaning)
      #   Col 3: Blue dye tips  (reused with cleaning)
      #   Col 4: Mix tips       (reused with cleaning)
      tip_columns:
        red: 1
        green: 2
        blue: 3
        mix: 4

    # Single-channel tiprack (left pipette) — for controls
    - name: "opentrons_96_filtertiprack_200ul"
      slot: "10"
      for: "left"
      # 4 reusable tips for control dispensing:
      #   A1: Red control tip   (dispenses pure Red into row A)
      #   B1: Green control tip (dispenses pure Green into row B)
      #   C1: Blue control tip  (dispenses pure Blue into row C)
      #   D1: Water control tip (dispenses pure Water into row D)
      control_tips:
        red: "A1"
        green: "B1"
        blue: "C1"
        blank: "D1"
      left_tip_notes:
        - "Use 'blank' (slot 3 diluent) as the true baseline."
        - "Clean water (slot 6) is for rinsing only."

  # Each dye has its own reservoir for clean separation
  sources:
    red:
      name: "nest_12_reservoir_15ml"
      slot: "7"
      well: "A1"
      # Preparation: ~50 uL concentrated red dye + 12 mL water
    green:
      name: "nest_12_reservoir_15ml"
      slot: "8"
      well: "A1"
      # Preparation: ~50 uL concentrated green dye + 12 mL water
    blue:
      name: "nest_12_reservoir_15ml"
      slot: "9"
      well: "A1"
      # Preparation: ~50 uL concentrated blue dye + 12 mL water

  water:
    name: "nest_12_reservoir_15ml"
    slot: "5"
    well: "A1"
    # Pure water for control row D (white baseline)

  # Cleaning reservoir
  cleaning:
    name: "nest_12_reservoir_15ml"
    slot: "4"
    # Pure water for tip cleaning between transfers
    columns:
      red_rinse: "A1"       # Rinse Red tips here
      green_rinse: "A2"     # Rinse Green tips here
      blue_rinse: "A3"      # Rinse Blue tips here
      mix_rinse: "A4"       # Rinse Mix tips here
      water_rinse: "A5"     # Rinse Water control tip here
      control_rinse: "A6"   # General rinse for single-channel

  plate:
    name: "corning_96_wellplate_360ul_flat"
    slot: "1"              # Front of deck — camera positioned above

# Explicit mapping (helps code resolve liquid names without guessing)
liquids:
  mapping:
    blank: { slot: "3", well: "A1" }
    red:   { slot: "7", well: "A1" }
    green: { slot: "8", well: "A1" }
    blue:  { slot: "9", well: "A1" }
    water: { slot: "5", well: "A1" }
    rinse: { slot: "4", well: "A1" }

# ============================================================
# Phase I: Well plate layout for single-well controls (LEFT pipette)
# ============================================================
#   Row A: Pure Red control    (200 uL via single-channel)
#   Row B: Pure Green control  (200 uL via single-channel)
#   Row C: Pure Blue control   (200 uL via single-channel)
#   Row D: Pure Water control  (200 uL via single-channel)
#   Row E: Experimental mix    (Vr+Vg+Vb via 8-channel, 4 tips)
#   Row F: Experimental mix    (replicate)
#   Row G: Experimental mix    (replicate)
#   Row H: Experimental mix    (replicate)
#
# Controls: R/G/B calibration + Water baseline (white point).
# 4 experiment replicates per column for noise estimation.

well_layout:
  phase: "phase1_single_well_controls"
  controls:
    A: { dye: "red",   volume: 200 }   # Pure Red
    B: { dye: "green", volume: 200 }   # Pure Green
    C: { dye: "blue",  volume: 200 }   # Pure Blue
    D: { dye: "water", volume: 200 }   # Pure Water (white baseline)

# ============================================================
# Camera configuration
# ============================================================
camera:
  device_id: 0
  width: 1920
  height: 1080
  warmup_frames: 10
  mount: "fixed_overhead"   # USB webcam fixed above slot 1

# ============================================================
# Experiment settings
# ============================================================
experiment:
  mode: "column"              # 1 experiment = 1 column
  n_initial: 5                # Random exploration experiments
  n_optimization: 7           # GP-guided optimization experiments
  max_per_plate: 12           # All 12 columns available
  batch_mode: true            # Pause for plate swap if not converged after 12
  settle_time_seconds: 45     # Wait after dispensing before imaging
  mix_cycles: 3               # Aspirate/dispense cycles during mix step
  mix_volume_ul: 150          # Volume for mixing (below 200 uL tip limit)

# ============================================================
# Tip cleaning settings
# ============================================================
cleaning:
  enabled: true               # Set to false to trash tips instead of reusing
  rinse_cycles: 3             # Aspirate/dispense in clean water 3x
  rinse_volume_ul: 200        # Volume per rinse cycle (max for 200 uL filter tips)
  blow_out_after: true        # Blow out after final rinse
  return_tips: true           # Return tips to home position (not trash)

# ============================================================
# ML configuration (Pure RGB — correlated multi-output GP)
# ============================================================
ml:
  model: "correlated_gp"      # KroneckerMultiTaskGP — learns R/G/B correlations
  # Alternative: "independent_gp" — 3 separate GPs (GP_R, GP_G, GP_B)
  acquisition: "EI"           # Expected Improvement (or "UCB")
  objective: "min_rgb_distance_to_target"
  n_replicates: 4             # Average 4 experiment wells (E-H) per column
  input_variables: ["R_ul", "G_ul", "B_ul"]
  constraint:
    type: "simplex_with_diluent"
    expression: "R_ul + G_ul + B_ul <= total_volume_ul"
    note: "blank_ul is computed as total_volume_ul - (R_ul + G_ul + B_ul)."
  # Maps: (Vr, Vg, Vb) -> predicted (R, G, B)
  # Acquisition minimizes: sqrt((pred_R-tR)^2 + (pred_G-tG)^2 + (pred_B-tB)^2)
  # Constraint: Vr + Vg + Vb = 200 enforced during optimization

# ============================================================
# Dispensing protocol per column
#
# Phase 1: Controls (single-channel, left pipette)
# Phase 2: Experimental mix (8-channel with 4 tips E-H, right pipette)
# Tips reused across all 12 columns with cleaning between.
# ============================================================
protocol_template:
  phase: "phase1"              # phase1 OR phase2

  - step: 1
    phase: "control"
    type: transfer
    dye: "red"
    source_slot: 7             # Red reservoir
    source_well: "A1"
    dest_row: "A"              # Row A = pure Red
    pipette: "left"
    tip_position: "A1"         # Dedicated Red control tip
    volume: 200
    post_transfer: [rinse, return]

  - step: 2
    phase: "control"
    type: transfer
    dye: "green"
    source_slot: 8             # Green reservoir
    source_well: "A1"
    dest_row: "B"              # Row B = pure Green
    pipette: "left"
    tip_position: "B1"         # Dedicated Green control tip
    volume: 200
    post_transfer: [rinse, return]

  - step: 3
    phase: "control"
    type: transfer
    dye: "blue"
    source_slot: 9             # Blue reservoir
    source_well: "A1"
    dest_row: "C"              # Row C = pure Blue
    pipette: "left"
    tip_position: "C1"         # Dedicated Blue control tip
    volume: 200
    post_transfer: [rinse, return]

  - step: 4
    phase: "control"
    type: transfer
    dye: "water"
    source_slot: 5             # Pure water reservoir
    source_well: "A1"
    dest_row: "D"              # Row D = pure Water (white baseline)
    pipette: "left"
    tip_position: "D1"         # Dedicated Water control tip
    volume: 200
    post_transfer: [rinse, return]

  - step: 5
    phase: "experiment"
    type: transfer
    dye: "red"
    source_slot: 7             # Red reservoir
    source_well: "A1"
    pipette: "right"           # 8-channel (4 tips: E-H)
    tip_column: 1
    # volume: Vr (from ML)
    post_transfer: [rinse, return]

  - step: 6
    phase: "experiment"
    type: transfer
    dye: "green"
    source_slot: 8             # Green reservoir
    source_well: "A1"
    pipette: "right"
    tip_column: 2
    # volume: Vg (from ML)
    post_transfer: [rinse, return]

  - step: 7
    phase: "experiment"
    type: transfer
    dye: "blue"
    source_slot: 9             # Blue reservoir
    source_well: "A1"
    pipette: "right"
    tip_column: 3
    # volume: Vb (from ML)
    post_transfer: [rinse, return]

  - step: 8
    phase: "experiment"
    type: mix
    pipette: "right"           # 8-channel (4 tips: E-H)
    tip_column: 4
    cycles: 3
    volume: 150                # Below 200 uL tip limit
    post_mix: [rinse, return]

# ============================================================
# Imaging plan (notes only)
# ============================================================
imaging_plan:
  notes:
    - "Wait settle_time_seconds after dispensing so liquid settles."
    - "Laptop triggers overhead camera capture of the full plate."
    - "Phase I: extract RGB from control rows (A–D)."
    - "Phase II: extract RGB from experiment replicate wells; compute mean/std for ML."

# ============================================================
# Dye preparation guide
# ============================================================
# Each dye reservoir: NEST 12-well, 15 mL capacity per well
#
# Starting recipe (tune with pilot run):
#   Red:   ~50 uL concentrated red food dye + 12 mL water → well A1 of slot 7
#   Green: ~50 uL concentrated green food dye + 12 mL water → well A1 of slot 8
#   Blue:  ~50 uL concentrated blue food dye + 12 mL water → well A1 of slot 9
#   Water: 15 mL pure water → well A1 of slot 5
#   Wash:  15 mL pure water in each used column of slot 4
#
# Calibration check: run 1 column, inspect control wells (A-D).
#   Good: dominant channel reads 200-240 (visible but not saturated)
#   Too dark: add more water to dye reservoir
#   Too light: add more concentrated dye

# ============================================================
# Data output
# ============================================================
output:
  base_dir: "data"
  save_images: true
  save_predictions: true
  log_format: "csv"
  notes:
    - "Phase I: log per-row RGB for controls (A–D)."
    - "Phase II: log per-experiment proposed volumes + measured RGB mean/std across replicates."
